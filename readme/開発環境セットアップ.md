# 開発オーナーの環境
Windows11  
pgAdmin4(v7.6)  
nodejs(v21.7.1)  
npm(v10.5.0)  

# 環境セットアップ
## 必要なもの
### postgreSQL
ローカル環境にpostgresqlがある状態にしてください  
pgAdmin4があると使いやすいです  
### nodejs環境
npmも含みできるだけ最新versionをインストールしてください  
### Google Cloud Platformアカウント
電話番号登録まではしなくていいです

## envファイルの作成
開発環境の場合はファイル名を`.env.local`とする  
.gitignoreの設定で`*.local.*`は全て追跡対象外になる  

## envの設定
### DATABASE_URL
"postgresql://\${username}:\${password}@localhost:\${port}/\${database}"の形に適切に設定してください

### GOOGLE_CLIENT_ID
Google Cloud PlatformにてOAuth2.0クライアントIDを作成してください  
#### GOOGLE_CLIENT_IDの設定
以下のサイトで作成できます  
https://console.cloud.google.com/apis/credentials  
- OAuthキーを作成する  
- WebアプリケーションのクライアントIDを取得する  
- 承認済みの JavaScript 生成元を"https://127.0.0.1:3000"とする  
- 承認済みのリダイレクト URIを"https://127.0.0.1:3000/api/auth/callback/google"とする  

#### GOOGLE_CLIENT_SECRET
GOOGLE_CLIENT_IDと一緒に取得できますので設定してください  

### NEXTAUTH_URL
"https://127.0.0.1:3000/"

### NEXT_AUTH_SECRET
WindowsのPowershellでopensslコマンドを実行してください  
`openssl rand -base64 32`

### NEXT_PUBLIC_IMGUR_CLIENT_ID
"9584cc0bcfc1f9a"を使用してください

### NEXT_PUBLIC_TRUTH_URL
"https://127.0.0.1:3000"

ENVは最終的に以下のようになります
```
DATABASE_URL="postgresql://${username}:${password}@localhost:${port}/${database}"
GOOGLE_CLIENT_ID="hoge-hoge.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="your_google_secret_key"
NEXTAUTH_URL="https://127.0.0.1:3000/"
NEXT_AUTH_SECRET="opensslコマンドからの出力"
NEXT_PUBLIC_IMGUR_CLIENT_ID="9584cc0bcfc1f9a"
NEXT_PUBLIC_TRUTH_URL="https://127.0.0.1:3000"
```

## ディレクトリの移動
親ディレクトリ(publicやreadmeディレクトリなどがある場所)までcdで移動してください

## npmでのモジュールのインストール
以下のコマンドでpackage.jsonを読み取ってnode_modulesをインストールできます  
`npm i`

## DBの初期化
以下のDBを作成してください  
Users
```sql
-- Table: public.Users

-- DROP TABLE IF EXISTS public."Users";

CREATE TABLE IF NOT EXISTS public."Users"
(
    "ID" text COLLATE pg_catalog."default" NOT NULL,
    username text COLLATE pg_catalog."default" NOT NULL,
    mail text COLLATE pg_catalog."default",
    icon text COLLATE pg_catalog."default" NOT NULL,
    "statusMessage" text COLLATE pg_catalog."default" NOT NULL,
    "answerScore" bigint NOT NULL,
    "pageScore" bigint NOT NULL,
    CONSTRAINT "Users_pkey" PRIMARY KEY ("ID")
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public."Users"
    OWNER to postgres;
```
Pages
```sql
-- Table: public.Pages

-- DROP TABLE IF EXISTS public."Pages";

CREATE TABLE IF NOT EXISTS public."Pages"
(
    "ID" text COLLATE pg_catalog."default" NOT NULL,
    "userID" text COLLATE pg_catalog."default" NOT NULL,
    title text COLLATE pg_catalog."default" NOT NULL,
    content text COLLATE pg_catalog."default" NOT NULL,
    "likeCount" bigint NOT NULL DEFAULT 0,
    "commentCount" bigint NOT NULL DEFAULT 0,
    tags text[] COLLATE pg_catalog."default" NOT NULL,
    "isPublic" boolean NOT NULL DEFAULT false,
    date date NOT NULL,
    CONSTRAINT "Pages_pkey" PRIMARY KEY ("ID")
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public."Pages"
    OWNER to postgres;

COMMENT ON COLUMN public."Pages"."ID"
    IS 'page id';

COMMENT ON COLUMN public."Pages".title
    IS 'page title';

COMMENT ON COLUMN public."Pages".content
    IS 'page content';
```

### DBテーブル増やすときの話
pgAdmin4を使用してSQLコマンドを実行すると便利です  
(DBのテーブルを増やす場合は連絡し上に付け足していき、コマンドを実行する)  
(DBのあるテーブル内のカラムを増やす場合は連絡し上記のコマンドを編集する)

## 実行方法
`npm run dev`を実行するとNextjsサーバーが立ち上がります  
<b>localhostではなく、`https://127.0.0.1:3000`のlocalhostと同じIPに入ってください</b>  
理由→imgurのAPIがlocalhostからの接続を受け入れない事になっているので、127...での接続で統一しようとしています  
もし別のIPしか使えないのであれば、このmd内のhttps://127...の部分を変えていただいたら動きます  